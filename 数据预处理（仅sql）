#数据预处理：去空，去重，去异常
#检查空值
select * from userbehavior where user_id is null;
select * from userbehavior where item_id is null;
select * from userbehavior where category_id is null;
select * from userbehavior where behavior_type is null;
select * from userbehavior where timestamps is null;

#检查重复值：分组后每组多于1项，就表示该项是重复值，以user_id,item_id,timestamps三个int识别重复值
select user_id,item_id,timestamps from userbehavior
group by user_id, item_id, timestamps
having count(*)>1;

#去重→希望在第一列建立从1开始的主键，并命名为id
alter table userbehavior add id int first;
select * from userbehavior limit 5;
alter table userbehavior modify id int primary key auto_increment;

#去重（self）→保留userbehavior表内重复值id更小的该行，利用userbehavior.id>u2.id仅去除重复重复值（保证相同两行有一行被保留）
with u2 as 
(
	select user_id,item_id,timestamps,min(id) as id from userbehavior
	group by user_id,item_id,timestamps
	having count(*)>1
	)

delete userbehavior from userbehavior
inner join u2 
	on  userbehavior.user_id=u2.user_id
	and userbehavior.item_id=u2.item_id
	and userbehavior.timestamps=u2.timestamps
where userbehavior.id>u2.id;

#去重
delete userbehavior from
userbehavior
(
	select user_id,item_id,timestamps,min(id) id from userbehavior
	group by user_id,item_id,timestamps
	having count(*)>1
	)u2
	where userbehavior.user_id=u2.user_id
	and userbehavior.item_id=u2.item_id
	and userbehavior.timestamps=u2.timestamps
	and userbehavior.id>u2.id;


#新增日期：date time hour
#更改buffer值
#查看缓冲值现在大小，更改缓冲值的大小
show VARIABLES like '%_buffer%';
set global innodb_buffer_pool_size=10700000000;

#datetimes修改
alter table userbehavior add datetimes timestamp(0);
update userbehavior set datetimes=FROM_UNIXTIME(timestamps);

#date与times
alter table userbehavior add dates char(10);
alter table userbehavior add times char(8);
alter table userbehavior add hours char(2);
update userbehavior set dates=substring(datetimes,1,10);
update userbehavior set times=substring(datetimes,12,8);
update userbehavior set hours=substring(datetimes,12,2);
select * from userbehavior limit 5;

#去异常：该数据应当是 2017年11月25日-2017年12月3日的，如果存在不在该范围的数据，则视为异常数据
select max(datetimes),min(datetimes) from userbehavior;
delete from userbehavior
where datetimes<'2017-11-25 00:00:00'
or datetimes>'2017-12-03 23:59:59';


#数据概览
desc userbehavior;
select * from userbehavior limit 5;
select count(1) from userbehavior;###目前仍有超1亿条数据--100095495
